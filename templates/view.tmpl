#*
Copyright (c) 2003-2009  Pavel Rychly

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; version 2
dated June, 1991.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
*#
#import locale
#from cmpltmpl.conc import conc
#from templating.filters import *
#extends conc

#def title
$_("Concordance")#slurp
#end def

#attr $focus = "'#next'"

#def headers
<link rel="stylesheet" type="text/css" href="$files_path/css/${css_prefix}jscrollpane.css" />
<script src="$files_path/js/soundmanager2.min.js" type="text/javascript"></script>
<script type="text/javascript">
soundManager.setup({
    url: '../files/misc/soundmanager2/',
    flashVersion: 9,
    debugMode : false,
    preferFlash : false
});
</script>
#if $righttoleft
<style>
.lc {direction: rtl}
.kw {direction: rtl}
.rc {direction: rtl}
</style>
#end if
#end def

#def bodyonload
require(['tpl/view', 'conf', 'domReady!'], function(pageSelf, conf) {
    conf.annotconc = "$annotconc";
    conf.q = "$q";
    conf.messages.ctrlc_to_copy = "$_('Press Ctrl+C to copy the text')";

    #if $can_annotate and $annotconc
    conf.canAnnotate = $can_annotate;
    conf.annotConc = "$annotconc";
    #end if

    conf.messages.calc_warning = '$_("Given frequency figures are related to the whole corpus, not only its part specified by the attribute values that have been entered to restrict the query results. Figures related to a given part of the corpus are displayed only when querying a pre-defined subcorpus.")';

    pageSelf.init(conf);

    #if not $finished and $async and $save and not $sampled_size
    conf.messages.using_random = '$_("using random")';
    conf.messages.using_first = '$_("Using first")';
    conf.messages.use_random = '$_("Use random")';
    conf.messages.instead = '$_("instead")';
    conf.messages.per_million = '$_("million")';
    conf.messages.calculating = ' $_("calculating...")';
    conf.messages.lines_only = ' $_("lines only").';
    conf.numLines = $len($Lines);
    conf.q = '$q';
    conf.q2 = '$q[2]';
    conf.q2toEnd = '$q[2:]';
    conf.globals = '$globals';
    pageSelf.reloadHits(conf);
    #end if
});
#end def


#def align_heading($viewmode, $KWICCorps)
#if $getVar('Par_conc_corpnames', [])
<tr>
    #for $i, $c in enumerate($Par_conc_corpnames)
    #if not $refs_up# <td></td> #end if#
    <td class="concordance-col-heading" #if $viewmode == 'kwic' and $c.n in $KWICCorps# colspan="3" align="center" #end if#>
    #if $c.n in $KWICCorps
    <a class="select-primary-lang" href="view?$q;$globals;q=x-$c.n;maincorp=$c.n" title="$_('Click to make the language primary')"><b>$c.label</b></a>
    #else
    <a class="select-primary-lang" href="filter_form?$q;$globals;maincorp=$c.n;within=1" title="$_('Click to make the language primary')"><b>$c.label</b></a>
    #end if
    </td>
    #if $copy_icon and $i == 0 # <td></td> #end if#
    #end for
</tr>
#end if
#end def

#def display_conc_line($l, $basecorpname, $viewmode, $KWICCorps, $longcorpname)
  #if $viewmode == 'kwic' and $basecorpname in $KWICCorps
    <td class="lc #if $basecorpname == $maincorp#maincorp#end if#" >
  #else
    <td class="par #if $basecorpname == $maincorp#maincorp#end if#">
    #if $annotconc
      <span class="groupbox" data-pos="$l.toknum">
      $l.linegroup</span>
    #end if
  #end if

  #set $closed_segment = None
  #for $ll in $l.Left
    #if $ll.has_key('open_link')
        #if $closed_segment and $closed_segment != $ll.open_link.speech_path# <a class="speech-link" href="${root_url}audio?$closed_segment&$ll.open_link.speech_path" title="Play both segments to the right and to the left">+</a> #end if#
        #set $closed_segment = None
    <a href="${root_url}audio?$ll.open_link.speech_path" class="speech-link" title="$_("Click to play audio")">[#if $ll.open_link.has_key('continued') #&hellip;#end if #</a>
    #end if

    #if $ll.has_key('class') and $ll.class
      <i class='$ll.class'>
    #end if
    $ll.str
    #if $ll.has_key('class') and $ll.class
      </i>
    #end if
    #if $ll.has_key('close_link')
       #set $closed_segment = $ll.close_link.speech_path
    <a href="${root_url}audio?$ll.close_link.speech_path" class="speech-link" title="$_("Click to play audio")">]</a>
    #end if

  #end for
  #if $viewmode == 'kwic' and $basecorpname in $KWICCorps
    </td><td class="kw #if $basecorpname == $maincorp#maincorp#end if#"
             data-url="widectx" data-params="pos=$l.toknum&hitlen=$l.hitlen&corpname=$longcorpname" data-loadtext="$_('Loading...')">
  #else
    #if not $l.Kwic
    <i class="note">$_('<--not translated-->')</i>
    #end if
    <span class="no-kwic-text" data-url="widectx" data-params="pos=$l.toknum&hitlen=$l.hitlen&corpname=$longcorpname" data-loadtext="$_('Loading...')">
  #end if
  #for $k in $l.Kwic

    ## opening audio bracket for KWIC
    #if $k.has_key('open_link')
        #if $closed_segment and $closed_segment != $k.open_link.speech_path# <a class="speech-link" href="${root_url}audio?$closed_segment&$k.open_link.speech_path" title="Play both segments to the right and to the left">+</a> #end if#
        #set $closed_segment = None
    <a href="${root_url}audio?$k.open_link.speech_path" class="speech-link" title="$_("Click to play audio")">[#if $k.open_link.has_key('continued') #&hellip;#end if #</a>
    #end if

    #if $k.get('class', '') and $basecorpname in $KWICCorps
      <b class='$k.class'>
    #end if
    $k.str
    #if $k.has_key('class') and $k.class
      </b>
    #end if

    ## closing audio breacket for KWIC
    #if $k.has_key('close_link')
       #set $closed_segment = $k.close_link.speech_path
    <a href="${root_url}audio?$k.close_link.speech_path" class="speech-link" title="$_("Click to play audio")">]</a>
    #end if

  #end for
  #if $viewmode == 'kwic' and $basecorpname in $KWICCorps
    </td><td class="rc #if $basecorpname == $maincorp#maincorp#end if#">
    #if $annotconc
      <span class="groupbox" data-pos="$l.toknum">$l.linegroup</span>
    #end if
  #else
    </span>
  #end if

  #set $closed_segment = None
  #for $rr in $l.Right
    #if $rr.has_key('open_link')
        #if $closed_segment and $closed_segment != $rr.open_link.speech_path# <a class="speech-link" href="${root_url}audio?$closed_segment&$rr.open_link.speech_path" title="Play both segments to the right and to the left">+</a> #end if#
        #set $closed_segment = None
    <a href="${root_url}audio?$rr.open_link.speech_path" class="speech-link" title="$_("Click to play audio")">[</a>
    #end if
    #if $rr.has_key('class') and $rr.class
      <i class='$rr.class'>
    #end if
    $rr.str
    #if $rr.has_key('class') and $rr.class
      </i>
    #end if
    #if $rr.has_key('close_link')
    <a href="${root_url}audio?$rr.close_link.speech_path" class="speech-link" title="$_("Click to play audio")">]</a>
    #set $closed_segment = $rr.close_link.speech_path
    #end if
  #end for
  </td>

  #if $corpname == 'syntaxtest_cs_a'
    <td>
    <div data-href="${root_url}view_tree?$ll.treex_view.path" class="treex-view"><img src="../files/img/lindat.pmltq.logo.png" style="width:24px;height:24px;border:0;" title="Tree view">
        <div id="treex-view"></div>
    </div>
    </td>
  #end if
#end def

#def oneclick_line($l, $i, $longcorpname)
  #if $copy_icon
    <td>
        <div class="copy_div"><a id="$i" class="copy-button" data-url="widectx_raw" data-params="pos=$l.toknum&hitlen=$l.hitlen&corpname=$longcorpname" data-loadtext="$_('Loading...')"></a></div>
    </td>
  #end if
#end def


#def concordance
#filter WebSafe

<div id="conc-wrapper">
    <div id="conc-top-bar">
        <div id="result-info">
            #if $usesubcorp
                $_("Subcorpus"): <strong>$usesubcorp</strong> <span class="separ">|</span>
            #end if

            #if $q[2] == "R"
                #set $online_sample = True
            #else
                #set $online_sample = False
            #end if

            $_('Hits'): <span id="loader"></span> <strong id="fullsize" title="$fullsize">#filter $IntegerFormatter#$concsize#end filter#</strong>
            #if $sampled_size# <span class="separ">|</span> $_("random sample of size") <strong>$sampled_size</strong>#end if#
            <span id="conc-calc-info" title="$concsize">#slurp
            #if $concsize != $fullsize
                #set $l=$locale.format("%d",$concsize,grouping=True)
                #if not $online_sample
                    $_('using first') $l $_('lines only'). <a href="view?q=R$q[2:];$globals">$_('Use random') $l $_('instead').</a>#slurp
                #else
                    $_('using random') $l#slurp
                    #if not $finished
                        $_('counting') ...#slurp
                    #end if
                    $_('lines only')#slurp
                #end if
            #end if
            </span>

            <span class="separ">|</span> <abbr title="$_('instances per million') $result_relative_freq_rel_to">i.p.m.</abbr>:
            <span class="ipm">#filter $FloatFormatter# $result_relative_freq #end filter#</span>
            $result_relative_freq_rel_to
            #if $result_arf
            <span class="separ">|</span> <abbr title="$_('Average Reduced Frequency')">$_('ARF')</abbr>:
            <strong id="arf">#filter $IntegerFormatter# $result_arf #end filter#</strong>
            #end if

            #if $contains_within
            <span class="separ">|</span>
            <a class="calc-warning" href="#"><img src="../files/img/warning-icon.png" /></a>
            #end if

            <span class="separ">|</span>
            <span class="notice-shuffled">
            #if $result_shuffled#$_('Result is shuffled')#else#$_('Result is sorted')#end if#
            </span>
        </div>

        #block navigation($navid="navigation_form", $nextid="next")
        ## navigation
        #if $numofpages
            <div class="bonito-pagination">
            <form action="view" id="$navid">
            #if $prevlink
                <div class="bonito-pagination-left">
                <a href="view?$q;$firstlink;$globals"><img class="over-img" src="../files/img/first-page.png" alt="$_("First")" title="$_("First")" data-alt-img="../files/img/first-page_s.png" /></a>
                <a href="view?$q;$prevlink;$globals"><img class="over-img" src="../files/img/prev-page.png" alt="$_("Previous")" title="$_("Previous")" data-alt-img="../files/img/prev-page_s.png" /></a>
                </div>
            #end if

            <div class="bonito-pagination-core">
              #filter None
              $input_hidden
              #end filter
              <input type="text" name="fromp" value="$fromp" size="2" />
              / <span class="numofpages" title="$numofpages">#filter $IntegerFormatter#$numofpages#end filter#</span>
            </div>

            #if $nextlink
                <div class="bonito-pagination-right">
                <a href="view?$q;$nextlink;$globals" id="$nextid"><img class="over-img" src="../files/img/next-page.png" alt="$_("Next")" title="$_("Next")" data-alt-img="../files/img/next-page_s.png" /></a>
                <a id="lastpage" href="view?$q;$lastlink;$globals"><img class="over-img" src="../files/img/last-page.png" alt="$_("Last")" title="$_("Last")" data-alt-img="../files/img/last-page_s.png" /></a>
                </div>
            #else
                <a id="$nextid"></a>
            #end if

            #if $Sort_idx
                <div class="jump-to">
                    $_("Jump to"):
                    <select onchange="this.form.fromp.value = this.value; this.form.submit();">
                    #for $idx in $Sort_idx
                        <option value="$idx.page" title="$idx.label" #if $idx.page == $fromp#selected="selected"#end if#>
                        #filter $Shortener
                        ${idx.label, length=20}
                        #end filter
                        </option>
                    #end for
                    </select>
                </div>
            #end if
            </form>
            </div>
        #end if
        #end block
    </div>


    ## concordance lines
    #set $basecorpname = $corpname.split('/')[-1]
    #set $cpath = ('/' in $corpname) and ($corpname.rsplit('/', 1)[-2] + '/') or ''
    #set $KWICCorps = list($getVar('CollCorps', [$basecorpname]))
    <div id="conclines-wrapper">
        #if $len($Lines) > 0
        <table id="conclines">
            #filter None
            $align_heading($viewmode, $KWICCorps)
            #end filter


            #for $i, $l in $enumerate($Lines)
            <tr toknum="$l.toknum" class="#if $annotconc#concline#elif $i%2# even#end if#">
                <td class="ref" data-url="fullref" data-params="pos=$l.toknum&corpname=$corpname" data-loadtext="$_('Loading...')">
                    $l.ref
                </td>
                #filter None
                #if $refs_up
                <td class="ref" #if $viewmode == 'kwic'# colspan="3" #end if# onclick="show_detail('fullref', 'pos=$l.toknum&corpname=$corpname', '$_("Loading...")', true);"><u class="note">$l.ref</u></td>
                #if $copy_icon# <td></td> #end if#
                #for $ii,$ll in $enumerate($l.get('Align', []))
                    #set $bcname = $Par_conc_corpnames[$ii+1].n
                    #if $ll.ref
                        <td class="ref" #if $viewmode == 'kwic' and $bcname in $KWICCorps# colspan="3" #end if# onclick="show_detail('fullref', 'pos=$ll.toknum&corpname=$cpath$bcname', '$_("Loading...")', true);"><u class="note">$ll.ref</u></td>
                    #else
                        <td></td>
                    #end if
                #end for
            </tr>
            <tr toknum="$l.toknum" class="#if $annotconc#concline#elif $i%2# even#end if#">
                $display_conc_line($l, $basecorpname, $viewmode, $KWICCorps, $corpname)
                $oneclick_line($l, $i, $corpname)
                #for $ii,$ll in $enumerate($l.get('Align', []))
                    #set $bcname = $Par_conc_corpnames[$ii+1].n
                    $display_conc_line($ll, $bcname, $viewmode, $KWICCorps, $cpath+$bcname)
                #end for
            #else ## standard display of refs
                $display_conc_line($l, $basecorpname, $viewmode, $KWICCorps, $corpname)
                $oneclick_line($l, $i, $corpname)
                #for $ii,$ll in $enumerate($l.get('Align', [])) ## aligned lines
                  #set $bcname = $Par_conc_corpnames[$ii+1].n
                  #if $ll.ref
                    <td class="ref" data-url="fullref" data-params="pos=$ll.toknum&corpname=$Par_conc_corpnames[$ii+1].n" data-loadtext="$_('Loading...')">$ll.ref</td>
                  #else
                    <td></td>
                  #end if
                  $display_conc_line($ll, $bcname, $viewmode, $KWICCorps, $cpath+$bcname)
                #end for
            #end if
            #end filter
            </tr>
            #end for
        </table>
        #end if
    </div>

    <div id="conc-bottom-bar">
    #filter None
    $navigation("navigation_form2", "next2")
    #end filter
    </div>
</div>

#end filter
#end def
