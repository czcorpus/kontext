#*
Copyright (c) 2003-2009  Pavel Rychly

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; version 2
dated June, 1991.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
*#
#from translation import ugettext as _
#from templating.filters import *
#from cmpltmpl.document import document
#extends document

#def title
$_("Concordance")#slurp
#end def

#def headers

#if $righttoleft
<style>
.lc {direction: rtl}
.kw {direction: rtl}
.rc {direction: rtl}
</style>
#end if
#end def

#def bodyonload
require(['${client_model_dir}/${page_model}', 'conf'], function(pageSelf, conf) {
    conf.q = "$q";
    conf.replicableQuery = #if $getVar('replicable_query', False)#true#else#false#end if#;
    conf.concLineMaxGroupNum = $conc_line_max_group_num;
    pageSelf.init(conf);

    #if not $finished and $async and $save and not $sampled_size
    conf.numLines = $len($Lines);
    conf.q = '$q';
    conf.q2 = '$q[2]';
    conf.q2toEnd = '$q[2:]';
    conf.globals = '$globals';
    pageSelf.reloadHits(conf);
    #end if
});
#end def


#def align_heading($viewmode, $KWICCorps)
#if $getVar('Par_conc_corpnames', [])
<tr>
    <td></td>  ## matches selection checkbox
    #for $i, $c in enumerate($Par_conc_corpnames)
    <td class="concordance-col-heading" #if not $refs_up#colspan="2"#end if# #if $viewmode == 'kwic' and $c.n in $KWICCorps# colspan="3" align="center" #end if#>
    #if $c.n in $KWICCorps
    <a class="select-primary-lang" href="view?$join_params($q, $Globals.update('maincorp', $c.n).update('viewmode', 'align'), 'q=x-' + $c.n)" title="$_('Click to make the language primary')"><b>$c.label</b></a>
    #else
    <a class="select-primary-lang" href="filter_form?$join_params($q, $globals, 'maincorp=' + $c.n, 'within=1')" title="$_('Click to make the language primary')"><b>$c.label</b></a>
    #end if
    </td>
    #end for
</tr>
#end if
#end def

#def display_conc_line($l, $basecorpname, $viewmode, $KWICCorps, $longcorpname)
  #if $viewmode == 'kwic' and $basecorpname in $KWICCorps
    <td class="lc #if $basecorpname == $maincorp#maincorp#end if#" >
  #else
    <td class="par #if $basecorpname == $maincorp#maincorp#end if#">
  #end if

  #set $closed_segment = None
  #for $ll in $l.Left
    #if $ll.has_key('open_link')
        #if $closed_segment and $closed_segment != $ll.open_link.speech_path# <a class="speech-link" href="${root_url}audio?$closed_segment&$ll.open_link.speech_path">+</a> #end if#
        #set $closed_segment = None
    <a href="${root_url}audio?$ll.open_link.speech_path" class="speech-link" title="$_("Click to play audio")">[#if $ll.open_link.has_key('continued') #&hellip;#end if #</a>
    #end if

    #if $ll.has_key('class') and $ll.class
      <i class='$ll.class'>
    #end if
    $ll.str
    #if $ll.has_key('class') and $ll.class
      </i>
    #end if
    #if $ll.has_key('close_link')
       #set $closed_segment = $ll.close_link.speech_path
    <a href="${root_url}audio?$ll.close_link.speech_path" class="speech-link" title="$_("Click to play audio")">]</a>
    #end if

  #end for
  #if $viewmode == 'kwic' and $basecorpname in $KWICCorps
    </td>
    <td class="kw #if $basecorpname == $maincorp#maincorp#end if#"
        data-url="widectx" data-params="$join_params('pos='+$str($l.toknum),
        'hitlen='+$str($l.hitlen), 'corpname='+$longcorpname, $widectx_globals)">
  #else
    #if not $l.Kwic
    <i class="note">$_('<--not translated-->')</i>
    #end if
    <span class="no-kwic-text" data-url="widectx" data-params="$join_params('pos='+$str($l.toknum),
        'hitlen='+$str($l.hitlen), 'corpname='+$longcorpname, $widectx_globals)">
  #end if
  #for $k in $l.Kwic

    ## opening audio bracket for KWIC
    #if $k.has_key('open_link')
        #if $closed_segment and $closed_segment != $k.open_link.speech_path# <a class="speech-link" href="${root_url}audio?$closed_segment&$k.open_link.speech_path">+</a> #end if#
        #set $closed_segment = None
    <a href="${root_url}audio?$k.open_link.speech_path" class="speech-link" title="$_("Click to play audio")">[#if $k.open_link.has_key('continued') #&hellip;#end if #</a>
    #end if

    #if $k.get('class', '') and $basecorpname in $KWICCorps
      <b class='$k.class'>
    #end if
    $k.str
    #if $k.has_key('class') and $k.class
      </b>
    #end if

    ## closing audio breacket for KWIC
    #if $k.has_key('close_link')
       #set $closed_segment = $k.close_link.speech_path
    <a href="${root_url}audio?$k.close_link.speech_path" class="speech-link" title="$_("Click to play audio")">]</a>
    #end if

  #end for
  #if $viewmode == 'kwic' and $basecorpname in $KWICCorps
    </td>
    <td class="rc #if $basecorpname == $maincorp#maincorp#end if#">
  #else
    </span>
  #end if

  #set $closed_segment = None
  #for $rr in $l.Right
    #if $rr.has_key('open_link')
        #if $closed_segment and $closed_segment != $rr.open_link.speech_path# <a class="speech-link" href="${root_url}audio?$closed_segment&$rr.open_link.speech_path">+</a> #end if#
        #set $closed_segment = None
    <a href="${root_url}audio?$rr.open_link.speech_path" class="speech-link" title="$_("Click to play audio")">[</a>
    #end if
    #if $rr.has_key('class') and $rr.class
      <i class='$rr.class'>
    #end if
    $rr.str
    #if $rr.has_key('class') and $rr.class
      </i>
    #end if
    #if $rr.has_key('close_link')
    <a href="${root_url}audio?$rr.close_link.speech_path" class="speech-link" title="$_("Click to play audio")">]</a>
    #set $closed_segment = $rr.close_link.speech_path
    #end if
  #end for
  </td>
#end def


#def num_hits($c_size, $f_size)
#if $c_size == $f_size:
<span id="conc-loader"></span> <strong id="fullsize" title="$f_size">$format_number($f_size, mask='%d')</strong>
#else
<a class="size-warning" data-size-limit="$format_number($c_size, mask='%d')"><img src="../files/img/warning-icon.png" /></a>
<span id="loader"></span>
<strong>$format_number($c_size, mask='%d')</strong> ($_('out of total') <span id="fullsize" title="$f_size">$format_number($f_size, mask='%d'))</span>
#end if
#end def

#def state_navigation
#filter None
$query_overview_bar()
#end filter
#end def


#def concordance
#filter WebSafe

<div id="conc-wrapper">
    <div id="conc-top-bar">
        <div id="result-info">
            #if $usesubcorp
                $_("Subcorpus"): <strong>$usesubcorp</strong> <span class="separ">|</span>
            #end if

            #if $q[2] == "R"
                #set $online_sample = True
            #else
                #set $online_sample = False
            #end if

            $_('Hits'): #filter None# $num_hits($concsize, $fullsize) #end filter#
            #if $sampled_size# <span class="separ">|</span> $_("random sample of size") <strong>$sampled_size</strong>#end if#
            <span id="conc-calc-info" title="$concsize">
            #if not $finished
              $_('calculating') ...#slurp
            #end if
            </span>

            <span class="separ">|</span>
            <abbr title="$_('instances per million positions') $result_relative_freq_rel_to">i.p.m.</abbr>:

            #if $getVar('cql_within_part', None) is None:
                <span class="ipm">$format_number($result_relative_freq, mask='%01.2f')</span>
                $result_relative_freq_rel_to
            #else
                <a class="calculate-ipm" data-total-hits="$fullsize"
                        data-query="#filter $URLEncode#$cql_within_part#end filter#">$_('calculate')</a>
            #end if



            #if $result_arf
            <span class="separ">|</span> <abbr title="$_('Average Reduced Frequency')">$_('ARF')</abbr>:
            <strong id="arf">$format_number($result_arf, mask='%01.2f')</strong>
            #end if

            <span class="separ">|</span>
            <span class="notice-shuffled">
            #if $result_shuffled#$_('Result is shuffled')#else#$_('Result is sorted')#end if#
            </span>
            <br />
            <div class="line-ops">
                $_('Line selection'):
                <select id="selection-mode-switch">
                    <option value="simple">$_('simple')</option>
                    <option value="groups">$_('groups')</option>
                </select>
                <span class="lines-selection"></span>
            </div>
        </div>

        #block navigation($navid="navigation_form", $nextid="next")
        ## navigation
        #if $numofpages
            <div class="bonito-pagination">
            <form action="view" id="$navid">
            #if $prevlink
                <div class="bonito-pagination-left">
                <a href="view?$join_params($q, $firstlink, $globals)"><img class="over-img" src="../files/img/first-page.png" alt="$_("First")" title="$_("First")" data-alt-img="../files/img/first-page_s.png" /></a>
                <a href="view?$join_params($q, $prevlink, $globals)"><img class="over-img" src="../files/img/prev-page.png" alt="$_("Previous")" title="$_("Previous")" data-alt-img="../files/img/prev-page_s.png" /></a>
                </div>
            #end if

            <div class="bonito-pagination-core">
              #filter None
              $input_hidden
              #end filter
              <input type="text" name="fromp" value="$fromp" size="2" />
              / <span class="numofpages" title="$numofpages">$format_number($numofpages, mask='%d')</span>
            </div>

            #if $nextlink
                <div class="bonito-pagination-right">
                <a href="view?$join_params($q, $nextlink, $globals)" id="$nextid"><img class="over-img" src="../files/img/next-page.png" alt="$_("Next")" title="$_("Next")" data-alt-img="../files/img/next-page_s.png" /></a>
                <a id="lastpage" href="view?$join_params($q, $lastlink, $globals)"><img class="over-img" src="../files/img/last-page.png" alt="$_("Last")" title="$_("Last")" data-alt-img="../files/img/last-page_s.png" /></a>
                </div>
            #else
                <a id="$nextid"></a>
            #end if

            #if $Sort_idx
                <div class="jump-to">
                    $_("Jump to"):
                    <select onchange="this.form.fromp.value = this.value; this.form.submit();">
                    #for $idx in $Sort_idx
                        <option value="$idx.page" title="$idx.label" #if $idx.page == $fromp#selected="selected"#end if#>
                        #filter $Shortener
                        ${idx.label, length=20}
                        #end filter
                        </option>
                    #end for
                    </select>
                </div>
            #end if
            </form>
            </div>
        #end if
        #end block
    </div>

    ## concordance lines
    #set $basecorpname = $corpname.split('/')[-1]
    #set $cpath = ('/' in $corpname) and ($corpname.rsplit('/', 1)[-2] + '/') or ''
    #if $len($CollCorps) == 0:
        #set $KWICCorps = list([$basecorpname])
    #else
        #set $KWICCorps = list($CollCorps)
    #end if
    <div id="conclines-wrapper">
        #if $len($Lines) > 0

        <table id="conclines">
            #filter None
            $align_heading($viewmode, $KWICCorps)
            #end filter

            #for $i, $l in $enumerate($Lines)
            <tr data-toknum="$l.toknum" data-linegroup="$l.linegroup">
                <td class="manual-selection">
                    <input type="checkbox" value="1" data-linenum="$l.linenum" data-position="$l.toknum"
                           data-kwiclen="$l.kwiclen" />
                </td>
                <td class="ref" data-url="fullref" data-params="pos=$l.toknum&corpname=$corpname" title="$l.ref">
                    $l.ref
                </td>

                #filter None
                    $display_conc_line($l, $basecorpname, $viewmode, $KWICCorps, $corpname)

                    #for $ii,$ll in $enumerate($l.get('Align', [])) ## aligned lines
                        #set $bcname = $Par_conc_corpnames[$ii+1].n
                        #if $ll.ref
                        <td class="ref" data-url="fullref" data-params="pos=$ll.toknum&corpname=$Par_conc_corpnames[$ii+1].n">$ll.ref</td>
                        #else
                        <td></td>
                        #end if
                        $display_conc_line($ll, $bcname, $viewmode, $KWICCorps, $cpath+$bcname)
                    #end for
                #end filter
            </tr>
            #end for
        </table>
        #end if
    </div>

    <div id="conc-bottom-bar">
    #filter None
    $navigation("navigation_form2", "next2")
    #end filter
    </div>
</div>

#end filter
#end def