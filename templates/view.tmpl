#*
Copyright (c) 2003-2009  Pavel Rychly

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; version 2
dated June, 1991.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
*#
#import locale
#from cmpltmpl.conc import conc
#from templating.filters import *
#extends conc

#def title
$_("Concordance")#slurp
#end def

#attr $focus = "'#next'"

#def headers
<link rel="stylesheet" type="text/css" href="$files_path/css/${css_prefix}view.css"
      xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html"/>
<script src="$files_path/js/tblex.js" type="text/javascript"></script>
<script src="$files_path/js/soundmanager2.min.js" type="text/javascript"></script>
#if $can_annotate and $annotconc
<script src="$files_path/js/annotconc.js" type="text/javascript"></script>
#end if
<script type="text/javascript">
soundManager.setup({
    url: '../files/misc/soundmanager2/',
    flashVersion: 9,
    debugMode : false,
    preferFlash : false
});
</script>
#if $righttoleft
<style>
.lc {direction: rtl}
.kw {direction: rtl}
.rc {direction: rtl}
</style>
#end if
#end def

#def left_submenu_save
#filter WebSafe
  <li><a title="$_("Save concordance to a text file or xml")" href="saveconc_form?$q;$globals&amp;fromp=$fromp&amp;pagesize=$pagesize&amp;leftctx=$leftctx.replace('#', '')&amp;rightctx=$rightctx.replace('#', '')">$_("Save")</a></li>
#end filter
#end def

#def left_submenu_options
  <li><strong>$_("View")</strong>
      <ul class="submenu">
          <li><a title="$_("Concordance view settings")" href="viewattrs?$q;$globals;fromp=$fromp">$_('Custom')</a></li>
          <li><a title="$_("Key Words In Context")" href="view?$q;${url_sub($globals,'viewmode','kwic')};fromp=$fromp">$_("KWIC")</a></li>
          <li><a title="$_("Show sentences")" href="view?$q;${url_sub($globals,'viewmode','sen')};fromp=$fromp">$_("Sentence")</a></li>
          #if $align
          <li><a title="$_("Show aligned segments")" href="view?$q;${url_sub($globals,'viewmode','align')};fromp=$fromp">$_("Alignment")</a></li>
          #end if
      </ul>
  </li>
#end def

#def viewblock
  <li><strong>$_("Sort")</strong>
    <ul class="submenu">
      <li><a title="$_("Complex sorting options")" href="sort?$q;$globals">$_('Custom')</a></li>
      <li><a title="$_("Sort to left")" href="sortx?$q;$globals;skey=lc;sicase=i">#*<img src="$files_path/img/sortleft.png" border="0" />*#$_("Left")</a>
        | <a title="$_("Sort to right")" href="sortx?$q;$globals;skey=rc;sicase=i">#*<img src="$files_path/img/sortright.png" border="0" />*#$_("Right")</a></li>
      <li><a title="$_("Sort by node word")" href="sortx?$q;$globals;skey=kw;sicase=i">#*<img src="$files_path/img/sortnode.png" border="0" />*#$_("Node")</a></li>
      #set $mlsortref = ''
      #set $i = 0
      #for $r in $refs.split(',')
        #set $i = $i + 1
        #set $mlsortref = $mlsortref + ('ml%dattr=' % $i) + $r.strip('=') + ';'
        #set $mlsortref = $mlsortref + ('ml%dpos=0;' % $i)
      #end for
      #set $mlsortref = $mlsortref + 'sortlevel=%d' % $i
      <li><a title="$_("Sort according to the 'References' field")" href="mlsortx?$q;$globals;$mlsortref">$_("References")</a></li>
      <li><a title="$_("Randomize ordering of lines")" href="view?$q;q=f;$globals">$_("Shuffle")</a></li>
    </ul>
  </li>
#end def

#def bodyonload
require(['tpl/view'], function(pageSelf) {
    conf.annotconc = "$annotconc";
    conf.q = "$q";

    #if $can_annotate and $annotconc
    conf.canAnnotate = $can_annotate;
    conf.annotConc = "$annotconc";
    #end if

    pageSelf.init(conf);

    #if not $finished and $async and $save and not $sampled_size
    conf.messages.using_random = '$_("using random")';
    conf.messages.using_first = '$_("using first")';
    conf.messages.use_random = '$_("Use random")';
    conf.messages.instead = '$_("instead")';
    conf.messages.per_million = '$_("million")';
    conf.messages.counting = ' ($_("counting ..."))';
    conf.messages.lines_only = ' $_("lines only").';
    conf.numLines = $len($Lines);
    conf.q = '$q';
    conf.q2 = '$q[2]';
    conf.q2toEnd = '$q[2:]';
    conf.globals = '$globals';
    pageSelf.reloadHits(conf);
    #end if
});
#end def

#def align_heading($viewmode, $KWICCorps)
#if $getVar('Par_conc_corpnames', [])
<tr>
    #for $i, $c in enumerate($Par_conc_corpnames)
    #if not $refs_up# <td></td> #end if#
    <td class="concordance-col-heading" #if $viewmode == 'kwic' and $c.n in $KWICCorps# colspan="3" align="center" #end if#>
    #if $c.n in $KWICCorps
    <a href="view?$q;$globals;q=x-$c.n;maincorp=$c.n"><b>$c.label</b></a>
    #else
    <a href="filter_form?$q;$globals;maincorp=$c.n;within=1"><b>$c.label</b></a>
    #end if
    </td>
    #if $copy_icon and $i == 0 # <td></td> #end if#
    #end for
</tr>
#end if
#end def

#def display_conc_line($l, $basecorpname, $viewmode, $KWICCorps, $longcorpname)
  #if $viewmode == 'kwic' and $basecorpname in $KWICCorps
    <td class="lc #if $basecorpname == $maincorp#maincorp#end if#" >
  #else
    <td class="par #if $basecorpname == $maincorp#maincorp#end if#">
    #if $annotconc
      <span class="groupbox" data-pos="$l.toknum">
      $l.linegroup</span>
    #end if
  #end if
  #for $ll in $l.Left
    #if $ll.has_key('open_link')
    <a href="$ll.open_link.speech_url" class="speech-link" title="$_("Click to play audio")">[#if $ll.open_link.has_key('continued') #&hellip;#end if #</a>
    #end if
    #if $ll.has_key('class') and $ll.class
      <i class='$ll.class'>
    #end if
    $ll.str
    #if $ll.has_key('class') and $ll.class
      </i>
    #end if
    #if $ll.has_key('close_link')
    <a href="$ll.close_link.speech_url" class="speech-link" title="$_("Click to play audio")">]</a>
    #end if
  #end for
  #if $viewmode == 'kwic' and $basecorpname in $KWICCorps
    </td><td class="kw #if $basecorpname == $maincorp#maincorp#end if#"
             data-url="widectx" data-params="pos=$l.toknum&hitlen=$l.hitlen&corpname=$longcorpname" data-loadtext="$_('Loading...')">
  #else
    #if not $l.Kwic
    <i class="note">$_('<--not translated-->')</i>
    #end if
    <span data-url="widectx" data-params="pos=$l.toknum&hitlen=$l.hitlen&corpname=$longcorpname" data-loadtext="$_('Loading...')">
  #end if
  #for $k in $l.Kwic
    #if $k.get('class', '') and $basecorpname in $KWICCorps
      <b class='$k.class'>
    #end if
    $k.str
    #if $k.has_key('class') and $k.class
      </b>
    #end if
  #end for
  #if $viewmode == 'kwic' and $basecorpname in $KWICCorps
    </td><td class="rc #if $basecorpname == $maincorp#maincorp#end if#">
    #if $annotconc
      <span class="groupbox" data-pos="$l.toknum">$l.linegroup</span>
    #end if
  #else
    </span>
  #end if
  #for $rr in $l.Right
    #if $rr.has_key('open_link')
    <a href="$rr.open_link.speech_url" class="speech-link" title="$_("Click to play audio")">[</a>
    #end if
    #if $rr.has_key('class') and $rr.class
      <i class='$rr.class'>
    #end if
    $rr.str
    #if $rr.has_key('class') and $rr.class
      </i>
    #end if
    #if $rr.has_key('close_link')
    <a href="$rr.close_link.speech_url" class="speech-link" title="$_("Click to play audio")">]</a>
    #end if
  #end for
  </td>
#end def

#def oneclick_line($l, $i)
  #if $copy_icon
    <td><div class="copy_div"><a href="#" class="copy_button" id="$i"></a></div>
      #for $ref_i, $ref in $enumerate($l.get('Tbl_refs', []))
<span id="ref$i-$ref_i" class="hidden">$ref</span>
      #end for
<span id="sent$i" class="hidden">#slurp
      #for $word in $l.Sen_Left
#slurp
$word.str#slurp
      #end for
#slurp
#if $l.Kwic and $l.Kwic[0]['str'].startswith(' ')
  #set $l['Kwic'][0]['str'] = $l.Kwic[0]['str'].strip()
 <b>#slurp
#else
<b>#slurp
#end if
      #for $word in $l.Kwic
#slurp
$word.str#slurp
      #end for
#slurp
</b>#slurp
      #for $word in $l.Sen_Right
#slurp
$word.str#slurp
      #end for
#slurp
</span></td>
  #end if

#end def


#def main
#filter WebSafe
    <div id="result-info">
        #if $usesubcorp
            $_("Subcorpus"): <strong>$usesubcorp</strong>
        #end if
        <br/>
        #if $q[2] == "R"
            #set $online_sample = True
        #else
            #set $online_sample = False
        #end if

        $_('Hits'): <strong>#filter $IntegerFormatter# $concsize #end filter#</strong>
        (<span class="ipm">#filter $FloatFormatter# $result_relative_freq #end filter#</span>
        <abbr title="$_('instances per million') ($result_relative_freq_rel_to)">i.p.m.</abbr>; $result_relative_freq_rel_to)
        #if $result_arf
        | <abbr title="$_('Average Reduced Frequency')">$_('ARF')</abbr>:
        <strong>#filter $IntegerFormatter# $result_arf #end filter#</strong>
        #end if
    </div>

## concordance annotation
#if $annotconc
    <i>$_("Annotating"):</i> <b>$annotconc</b>&nbsp;&nbsp;
    <a href="lngroupinfo?$q;$globals">$_("Info")</a>
    <a href="view?$q;q=g$annotconc;$globals">$_("Sort")</a>
    <a href="view?$q;$globals;annotconc=--NONE--">$_("Finish")</a>
    #if $can_annotate
        &nbsp;&nbsp;
        <i>$_("New pattern"):</i> <input id="newlabel" type="text" size="10" />
        <input class="add-new-annotation-label" type="submit" value="Add" />
        <span id="number_globally">$_("Number globally"):
           <span class="groupbox" data-pos="select">X</span>
        </span>
        <span id="number_selected" style="display:none">$_("Number selected")
          (<span id="num_of_selected_lines">0</span>):
           <span class="groupbox" data-pos="select">X</span>
           <a class="clear-selection" href="#">$_("Clear selection")</a>
        </span>
        <span id="annot_undo" style="display:none">
          <span id="annot_undo_count">0</span> lines assigned. Undo.</span>

        <div id="groupmenu">
        <table>
           #for $g in $GroupNumbers
              <tr>
              #for $i in $g.Items
                 <td class="assign-group" data-grpid="${i['n']}" data-grplabel="${i['lab']}">$i.lab</td>
              #end for
              </tr>
           #end for
              <tr><td class="add-new-annotation-label" colspan="3">$_("Add next")</td></tr>
              <tr><td class="assign-group" colspan="3" data-grpid="0" data-grplabel="_">$_("None")</td></tr>
        </table>
        </div>
    #end if
#end if

#block navigation($navid="navigation_form", $nextid="next")
## navigation
#if $numofpages
    <div class="bonito-pagination">
    <form action="view" id="$navid">
    #if $prevlink
        <div class="bonito-pagination-left">
        <a href="view?$q;$firstlink;$globals">$_("First")</a> |
        <a href="view?$q;$prevlink;$globals">$_("Previous")</a>
        </div>
    #end if

    <div class="bonito-pagination-core">
      #filter None
      $input_hidden
      #end filter
      $_("Page")
      <input type="text" name="fromp" value="$fromp" size="4" />
      #set $l_numofpages=$locale.format("%d",$numofpages,grouping=True)
      $_("of") <span name="numofpages" title="$numofpages">$l_numofpages</span>
      <input type="submit" value="$_("Go")" />
    </div>

    #if $nextlink
        <div class="bonito-pagination-right">
        <a href="view?$q;$nextlink;$globals" id="$nextid">$_("Next")</a> |
        <a id="lastpage" href="view?$q;$lastlink;$globals">$_("Last")</a>
        </div>
    #else
        <a id="$nextid"></a>
    #end if

    #if $Sort_idx
        &nbsp; &nbsp; $_("Concordance is sorted. Jump to"):
        <select onchange="this.form.fromp.value = this.value; this.form.submit();">
        #for $idx in $Sort_idx
            <option value="$idx.page"
            #if $idx.page == $fromp
                selected="selected"
            #end if
            >$idx.label</option>
        #end for
        </select>
    #end if
    </form>
    </div>
#end if
#end block

## concordance lines
#set $basecorpname = $corpname.split('/')[-1]
#set $cpath = ('/' in $corpname) and ($corpname.rsplit('/', 1)[-2] + '/') or ''
#set $KWICCorps = list($getVar('CollCorps', [$basecorpname]))
<table id="conclines">
#filter None
$align_heading($viewmode, $KWICCorps)
#end filter
#if $len($Lines) > 0
    #for $i, $l in $enumerate($Lines)
      <tr toknum="$l.toknum" class="#if $annotconc#concline#elif $i%2# even#end if#">
      <td class="ref" data-url="fullref" data-params="pos=$l.toknum&corpname=$corpname" data-loadtext="$_('Loading...')">$l.ref</td>
      #filter None
        #if $refs_up
          <td class="ref" #if $viewmode == 'kwic'# colspan="3" #end if# onclick="show_detail('fullref', 'pos=$l.toknum&corpname=$corpname', '$_("Loading...")', true);"><u class="note">$l.ref</u></td>
            #if $copy_icon# <td></td> #end if#
            #for $ii,$ll in $enumerate($l.get('Align', []))
                #set $bcname = $Par_conc_corpnames[$ii+1].n
                #if $ll.ref
                    <td class="ref" #if $viewmode == 'kwic' and $bcname in $KWICCorps# colspan="3" #end if# onclick="show_detail('fullref', 'pos=$ll.toknum&corpname=$cpath$bcname', '$_("Loading...")', true);"><u class="note">$ll.ref</u></td>
                #else
                    <td></td>
                #end if
            #end for
            </tr><tr toknum="$l.toknum" class="#if $annotconc#concline#elif $i%2# even#end if#">
            $display_conc_line($l, $basecorpname, $viewmode, $KWICCorps, $corpname)
            $oneclick_line($l, $i)
            #for $ii,$ll in $enumerate($l.get('Align', []))
                #set $bcname = $Par_conc_corpnames[$ii+1].n
                $display_conc_line($ll, $bcname, $viewmode, $KWICCorps, $cpath+$bcname)
            #end for
        #else ## standard display of refs
            $display_conc_line($l, $basecorpname, $viewmode, $KWICCorps, $corpname)
            $oneclick_line($l, $i)
            #for $ii,$ll in $enumerate($l.get('Align', [])) ## aligned lines
              #set $bcname = $Par_conc_corpnames[$ii+1].n
              #if $ll.ref
                <td class="ref" data-url="fullref" data-params="pos=$ll.toknum&corpname=$Par_conc_corpnames[$ii+1].n" data-loadtext="$_('Loading...')">$ll.ref</td>
              #else
                <td></td>
              #end if
              $display_conc_line($ll, $bcname, $viewmode, $KWICCorps, $cpath+$bcname)
            #end for
        #end if
      #end filter
      </tr>
    #end for
    </table>
#end if

#filter None
$navigation("navigation_form2", "next2")
#end filter

<div id="detailframe">
  <a id="hideel">
    <img src="$files_path/img/roll_down.png" alt="$_("hide detail")" title="$_('click to close')" />
  </a>
  <div id="detailframecontent"></div>
</div>

#end filter
#end def