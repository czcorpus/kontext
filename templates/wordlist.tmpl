#*
Copyright (c) 2003-2009  Pavel Rychly

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; version 2
dated June, 1991.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
*#

#from cmpltmpl.document import document
#extends document

#def title
$_("Word list")#slurp
#end def

#def headers
#filter WebSafe
#set global $new_maxitems = $wlmaxitems / $wlpage
#set global $url_wlpat = $urlquote($wlpat)
#set global $url_usesubcorp = $urlquote($usesubcorp)
#set global $curr_settings = '%s;usesubcorp=%s;wlattr=%s;wlminfreq=%s;wlpat=%s;wlicase=%s;wlmaxitems=%s;wlsort=%s;ref_corpname=%s;ref_usesubcorp=%s;wlcache=%s;simple_n=%s;wltype=%s;wlnums=%s;include_nonwords=%s;blcache=%s;wlpage=%s' % ($corpname_url, $url_usesubcorp, $wlattr, $wlminfreq, $url_wlpat, $wlicase, $new_maxitems, $wlsort, $ref_corpname, $ref_usesubcorp, $wlcache, $simple_n, $wltype, $wlnums, $include_nonwords, $blcache, $wlpage)

 #if $processing
   <meta http-equiv="refresh" content="3;wordlist?$curr_settings">
 #end if
#end filter
#end def

#def left_submenu_options
#filter WebSafe
  <li><a href="wordlist_form?$curr_settings">$_("Change options")</a></li>
#end filter
#end def

#def left_submenu_save
#filter WebSafe
<li><a title="$_("Save Word List/Keywords to a text file or XML")" href="savewl_form?$curr_settings">$_("Save")</a></li>
#end filter
#end def

#def bodyonload
require(['tpl/wordlist', 'domReady!'], function(pageSelf, domReady) {
    conf.corpnameUrl = "$corpname_url";
    conf.subcName = "$usesubcorp";
    conf.attrName = "$wlattr";
    conf.reloadUrl = "$reload_url";
    pageSelf.init(conf);
    #if $processing
    pageSelf.startWatching();
    #end if
});
#end def


#def main
#filter WebSafe
  <h3>$_("Word list")</h3>
  $_("Corpus"): <b>$corp_full_name</b>
#if $usesubcorp
  <br/>$_("Subcorpus"): <b>$usesubcorp</b>
#end if
#if $Keywords
  <br/>
  <br/>$_("Reference corpus"):  <b>$ref_corp_full_name</b>
  #if $ref_usesubcorp
    <br/>$_("Reference subcorpus"): <b>$ref_usesubcorp</b>
  #end if
#end if

#if $processing
    <div id="progress_message">
       $_("Subcorpora operations need more preprocessing. It will take a while, please wait.")
       <p>$_("Once the list has been computed, it will be stored, so will be immediately available next time.")</p>
       <p>$_("You can close this window. Repeating wordlist or keywords queries on the same subcorpus will show you progress of the computation.")</p>
       <img src="../files/img/ajax-loader.gif" alt="$_('calculating ...')" title="$_('calculating ...')" style="width: 24px; height: 24px; margin-right: 40px" />
       <div id="progress_scale">
            <div id="processbar" style="width:$processing%;"></div>
       </div> 
    </div>
#end if


#block navigation($navid="next")
#if ($getVar('Items', '') or $getVar('Keywords', '')) and not ($wlpage == 1 and $lastpage)
<div class="bonito-pagination">
<form action="wordlist">
  #if $wlpage > 1
    <div class="bonito-pagination-left">
    #set $firstlink_sett = $url_sub($curr_settings, 'wlpage', 1)
    <a href="wordlist?$firstlink_sett">$_("<< First")</a> |
    #set $prevlink_sett = $url_sub($curr_settings, 'wlpage', int($wlpage) - 1)
    <a href="wordlist?$prevlink_sett">$_("< Previous")</a>
    </div>
  #end if

<div class="bonito-pagination-core">
    <input type="hidden" name="corpname" value='$corpname' />
    <input type="hidden" name="usesubcorp" value='$usesubcorp' />
    <input type="hidden" name="wlattr" value='$wlattr' />
    <input type="hidden" name="wlminfreq" value='$wlminfreq' />
    <input type="hidden" name="wlpat" value='$wlpat' />
    <input type="hidden" name="wlicase" value='$wlicase' />
    <input type="hidden" name="wlmaxitems" value='$new_maxitems' />
    <input type="hidden" name="wlsort" value='$wlsort' />
    <input type="hidden" name="ref_corpname" value='$ref_corpname' />
    <input type="hidden" name="ref_usesubcorp" value='$ref_usesubcorp' />
    <input type="hidden" name="wlcache" value='$wlcache' />
    <input type="hidden" name="simple_n" value='$simple_n' />
    <input type="hidden" name="wltype" value='$wltype' />
    <input type="hidden" name="wlnums" value='$wlnums' />
    <input type="hidden" name="include_nonwords" value='$include_nonwords' />
    <input type="hidden" name="blcache" value='$blcache' />

  $_("Page")
  <input type="text" name="wlpage" value="$wlpage" size="4" />
  <input type="submit" value="$_("Go")" />
</div>

  #if not $lastpage
  <div class="bonito-pagination-right">
    #set $nextlink_sett = $url_sub($curr_settings, 'wlpage', int($wlpage) + 1)
  <a href="wordlist?$nextlink_sett" id="$navid">$_("Next >")</a>
  </div>
  #else
  <a id="$navid"></a>
  #end if
</form>
</div> 
#end if
#end block

<table class="result numtab">

#if $Items
    #if $wlattr != 'ws_collocations'
      #set $attrsort_sett = $url_sub($curr_settings, 'wlsort', '')
      #set $freqsort_sett = $url_sub($curr_settings, 'wlsort', 'f')
      <thead><tr>
      <th><a href="wordlist?$attrsort_sett">$wlattr_label</a></th>
      <th><a href="wordlist?$freqsort_sett">$_("Freq")</a></th>
      </tr></thead>
    #else
      <thead><tr><th>$wlattr</th><th>$_("Freq")</th></tr></thead>
    #end if
  #for $i in $Items
    <tr class="$i.get('class')" >
    #if $wlattr == 'ws_collocations'
      <td class="left">$i.w1 <sub><span class="note">$i.gramrel</span></sub> $i.w2</td>
      <td><a href="view?q=w$i.seek;$corpname_url;usesubcorp=$url_usesubcorp">$i.freq</a></td>
    #else
      #set $url_str = $urlquote($i.str.replace('\\', '\\\\').replace('"', '\\"'))
      <td class="left">$i.str</td><td>
      #if '.' in $wlattr
        $i.freq
      #else
        <a href="first?$corpname_url;usesubcorp=$url_usesubcorp;cql=%5B$wlattr%3D%3D%22$url_str%22%5D;default_attr=$wlattr;qmcase=1;queryselector=cqlrow">$i.freq</a>
      #end if
      </td>
    #end if
    </tr>
  #end for

## keywords
#elif $Keywords
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="3" border="1"><i>$corp_full_name#if $usesubcorp# : $usesubcorp#end if</i></th>
      <th></th>
      <th colspan="3" border="1"><i>$ref_corp_full_name#if $ref_usesubcorp# : $ref_usesubcorp#end if</i></th>
      <th></th>
      <th></th>
    </tr>
    <tr>
      <th>$wlattr</th>
      <th width="10"></th>
      <th>$_("Freq")</th>
      <th>$_("Freq/mill")</th>
      <th width="10"></th>
      <th>$_("Freq")</th>
      <th>$_("Freq/mill")</th>
      <th width="10"></th>
      <th>$_("Score")</th>
    </tr>
  </thead>
  #for $k in $Keywords
    <tr
    #if $k.has_key('class')
      class="$k.class"
    #end if
    >
    #if $wlattr == 'ws_collocations'
      #set $w1, $gramrel, $w2, $seek = $k.str.split('\t')
      <td class="left">$w1 <sub><span class="note">$gramrel</span></sub> $w2</td>
      <td></td>
      <td><a href="view?q=w$seek;$corpname_url;usesubcorp=$url_usesubcorp">$k.freq</a></td>
    #else
      <td class="left">$k.str</td>
      <td></td>
      #set $url_str = $urlquote($k.str.replace('"', '\\"'))
      <td><a href="first?$corpname_url;usesubcorp=$url_usesubcorp;phrase=$url_str;default_attr=$wlattr;qmcase=1;queryselector=phraserow">$k.freq</a></td>
    #end if
      <td>$k.rel</td>
      <td></td>
      <td>
      #if $k.freq_ref
        #if $wlattr == 'ws_collocations'
          <a href="view?q=w$seek;corpname=$ref_corpname;usesubcorp=$ref_usesubcorp">$k.freq_ref</a>
        #else
          <a href="first?corpname=$ref_corpname;usesubcorp=$ref_usesubcorp;phrase=$url_str;default_attr=$wlattr;qmcase=1;queryselector=phraserow">$k.freq_ref</a>
        #end if
      #else
        0
      #end if
      </td>
      <td>$k.rel_ref</td>
      <td></td>
      <td> $k.score</td>
    </tr>
  #end for
#elif not $processing
## no keywords && no items
  <i>$_("Nothing found.")</i>
#end if
</table>
#end filter

#filter none
$navigation("next2")
#end filter

#end def
