/*
 * Copyright (c) 2017 Charles University in Prague, Faculty of Arts,
 *                    Institute of the Czech National Corpus
 * Copyright (c) 2017 Tomas Machalek <tomas.machalek@gmail.com>
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; version 2
 * dated June, 1991.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.

 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */

const DFLIST = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 15, 20, 24, 30, 40, 60, 120, 1000];
const BINOM = {
    "0.1": [
        [39.8635, 8.5263, 5.5383, 4.5448, 4.0604, 3.7759, 3.5894, 3.4579, 3.3603, 3.285, 3.1765, 3.0732, 2.9747, 2.9271, 2.8807, 2.8354, 2.7911, 2.7478, 2.7106],
        [49.5, 9.0, 5.4624, 4.3246, 3.7797, 3.4633, 3.2574, 3.1131, 3.0065, 2.9245, 2.8068, 2.6952, 2.5893, 2.5383, 2.4887, 2.4404, 2.3933, 2.3473, 2.3079],
        [53.5932, 9.1618, 5.3908, 4.1909, 3.6195, 3.2888, 3.0741, 2.9238, 2.8129, 2.7277, 2.6055, 2.4898, 2.3801, 2.3274, 2.2761, 2.2261, 2.1774, 2.13, 2.0893],
        [55.833, 9.2434, 5.3426, 4.1072, 3.5202, 3.1808, 2.9605, 2.8064, 2.6927, 2.6053, 2.4801, 2.3614, 2.2489, 2.1949, 2.1422, 2.0909, 2.041, 1.9923, 1.9505],
        [57.2401, 9.2926, 5.3092, 4.0506, 3.453, 3.1075, 2.8833, 2.7264, 2.6106, 2.5216, 2.394, 2.273, 2.1582, 2.103, 2.0492, 1.9968, 1.9457, 1.8959, 1.853],
        [58.2044, 9.3255, 5.2847, 4.0097, 3.4045, 3.0546, 2.8274, 2.6683, 2.5509, 2.4606, 2.331, 2.2081, 2.0913, 2.0351, 1.9803, 1.9269, 1.8747, 1.8238, 1.78],
        [58.906, 9.3491, 5.2662, 3.979, 3.3679, 3.0145, 2.7849, 2.6241, 2.5053, 2.414, 2.2828, 2.1582, 2.0397, 1.9826, 1.9269, 1.8725, 1.8194, 1.7675, 1.7228],
        [59.439, 9.3668, 5.2517, 3.9549, 3.3393, 2.983, 2.7516, 2.5893, 2.4694, 2.3772, 2.2446, 2.1185, 1.9985, 1.9407, 1.8841, 1.8289, 1.7748, 1.722, 1.6764],
        [59.8576, 9.3805, 5.24, 3.9357, 3.3163, 2.9577, 2.7247, 2.5612, 2.4403, 2.3473, 2.2135, 2.0862, 1.9649, 1.9063, 1.849, 1.7929, 1.738, 1.6842, 1.6378],
        [60.195, 9.3916, 5.2304, 3.9199, 3.2974, 2.9369, 2.7025, 2.538, 2.4163, 2.3226, 2.1878, 2.0593, 1.9367, 1.8775, 1.8195, 1.7627, 1.707, 1.6524, 1.6051],
        [60.7052, 9.4081, 5.2156, 3.8955, 3.2682, 2.9047, 2.6681, 2.502, 2.3789, 2.2841, 2.1474, 2.0171, 1.8924, 1.8319, 1.7727, 1.7146, 1.6574, 1.6012, 1.5524],
        [61.2203, 9.4247, 5.2003, 3.8704, 3.238, 2.8712, 2.6322, 2.4642, 2.3396, 2.2435, 2.1049, 1.9722, 1.8449, 1.7831, 1.7223, 1.6624, 1.6034, 1.545, 1.4941],
        [61.7403, 9.4413, 5.1845, 3.8443, 3.2067, 2.8363, 2.5947, 2.4246, 2.2983, 2.2007, 2.0597, 1.9243, 1.7938, 1.7302, 1.6673, 1.6052, 1.5435, 1.4821, 1.428],
        [62.002, 9.4496, 5.1764, 3.831, 3.1905, 2.8183, 2.5753, 2.4041, 2.2768, 2.1784, 2.036, 1.899, 1.7667, 1.7019, 1.6377, 1.5741, 1.5107, 1.4472, 1.3909],
        [62.265, 9.4579, 5.1681, 3.8174, 3.1741, 2.8, 2.5555, 2.383, 2.2547, 2.1554, 2.0115, 1.8728, 1.7382, 1.6721, 1.6065, 1.5411, 1.4755, 1.4094, 1.3501],
        [62.5291, 9.4662, 5.1597, 3.8036, 3.1573, 2.7812, 2.5351, 2.3614, 2.232, 2.1317, 1.9861, 1.8454, 1.7083, 1.6407, 1.5732, 1.5056, 1.4373, 1.3676, 1.304],
        [62.7943, 9.4746, 5.1512, 3.7896, 3.1402, 2.762, 2.5142, 2.3391, 2.2085, 2.1072, 1.9597, 1.8168, 1.6768, 1.6073, 1.5376, 1.4672, 1.3952, 1.3203, 1.25],
        [63.0606, 9.4829, 5.1425, 3.7753, 3.1228, 2.7423, 2.4928, 2.3162, 2.1843, 2.0818, 1.9323, 1.7867, 1.6433, 1.5715, 1.4989, 1.4248, 1.3476, 1.2646, 1.1813],
        [63.296, 9.4902, 5.1348, 3.7625, 3.1072, 2.7246, 2.4735, 2.2954, 2.1623, 2.0586, 1.9071, 1.7589, 1.6118, 1.5375, 1.4617, 1.383, 1.2988, 1.2026, 1.0845]
    ],
    "0.01": [
        [4052.1807, 98.5025, 34.1162, 21.1977, 16.2582, 13.745, 12.2464, 11.2586, 10.5614, 10.0443, 9.3302, 8.6831, 8.096, 7.8229, 7.5625, 7.3141, 7.0771, 6.8509, 6.6603],
        [4999.5, 99.0, 30.8165, 18.0, 13.2739, 10.9248, 9.5466, 8.6491, 8.0215, 7.5594, 6.9266, 6.3589, 5.8489, 5.6136, 5.3903, 5.1785, 4.9774, 4.7865, 4.6264],
        [5403.352, 99.1662, 29.4567, 16.6944, 12.06, 9.7795, 8.4513, 7.591, 6.9919, 6.5523, 5.9525, 5.417, 4.9382, 4.7181, 4.5097, 4.3126, 4.1259, 3.9491, 3.8012],
        [5624.5833, 99.2494, 28.7099, 15.977, 11.3919, 9.1483, 7.8466, 7.0061, 6.4221, 5.9943, 5.412, 4.8932, 4.4307, 4.2184, 4.0179, 3.8283, 3.649, 3.4795, 3.338],
        [5763.6496, 99.2993, 28.2371, 15.5219, 10.967, 8.7459, 7.4604, 6.6318, 6.0569, 5.6363, 5.0643, 4.5556, 4.1027, 3.8951, 3.699, 3.5138, 3.3389, 3.1735, 3.0355],
        [5858.9861, 99.3326, 27.9107, 15.2069, 10.6723, 8.4661, 7.1914, 6.3707, 5.8018, 5.3858, 4.8206, 4.3183, 3.8714, 3.6667, 3.4735, 3.291, 3.1187, 2.9559, 2.82],
        [5928.3557, 99.3564, 27.6717, 14.9758, 10.4555, 8.26, 6.9928, 6.1776, 5.6129, 5.2001, 4.6395, 4.1415, 3.6987, 3.4959, 3.3045, 3.1238, 2.953, 2.7918, 2.6572],
        [5981.0703, 99.3742, 27.4892, 14.7989, 10.2893, 8.1017, 6.84, 6.0289, 5.4671, 5.0567, 4.4994, 4.0045, 3.5644, 3.3629, 3.1726, 2.993, 2.8233, 2.6629, 2.529],
        [6022.4732, 99.3881, 27.3452, 14.6591, 10.1578, 7.9761, 6.7188, 5.9106, 5.3511, 4.9424, 4.3875, 3.8948, 3.4567, 3.256, 3.0665, 2.8876, 2.7185, 2.5586, 2.425],
        [6055.8467, 99.3992, 27.2287, 14.5459, 10.051, 7.8741, 6.6201, 5.8143, 5.2565, 4.8491, 4.2961, 3.8049, 3.3682, 3.1681, 2.9791, 2.8005, 2.6318, 2.4721, 2.3386],
        [6106.3207, 99.4159, 27.0518, 14.3736, 9.8883, 7.7183, 6.4691, 5.6667, 5.1114, 4.7059, 4.1553, 3.6662, 3.2311, 3.0316, 2.8431, 2.6648, 2.4961, 2.3363, 2.2025],
        [6157.2846, 99.4325, 26.8722, 14.1982, 9.7222, 7.559, 6.3143, 5.5151, 4.9621, 4.5581, 4.0096, 3.5222, 3.088, 2.8887, 2.7002, 2.5216, 2.3523, 2.1915, 2.0565],
        [6208.7302, 99.4492, 26.6898, 14.0196, 9.5526, 7.3958, 6.1554, 5.3591, 4.808, 4.4054, 3.8584, 3.3719, 2.9377, 2.738, 2.5487, 2.3689, 2.1978, 2.0346, 1.8967],
        [6234.6309, 99.4575, 26.5975, 13.9291, 9.4665, 7.3127, 6.0743, 5.2793, 4.729, 4.3269, 3.7805, 3.294, 2.8594, 2.6591, 2.4689, 2.288, 2.1154, 1.95, 1.8096],
        [6260.6486, 99.4658, 26.5045, 13.8377, 9.3793, 7.2285, 5.992, 5.1981, 4.6486, 4.2469, 3.7008, 3.2141, 2.7785, 2.5773, 2.386, 2.2034, 2.0285, 1.86, 1.7158],
        [6286.7821, 99.4742, 26.4108, 13.7454, 9.2912, 7.1432, 5.9084, 5.1156, 4.5666, 4.1653, 3.6192, 3.1319, 2.6947, 2.4923, 2.2992, 2.1142, 1.936, 1.7628, 1.6127],
        [6313.0301, 99.4825, 26.3164, 13.6522, 9.202, 7.0567, 5.8236, 5.0316, 4.4831, 4.0819, 3.5355, 3.0471, 2.6077, 2.4035, 2.2079, 2.0194, 1.8363, 1.6557, 1.4953],
        [6339.3913, 99.4908, 26.2211, 13.5581, 9.1118, 6.969, 5.7373, 4.9461, 4.3978, 3.9965, 3.4494, 2.9595, 2.5168, 2.31, 2.1108, 1.9172, 1.7263, 1.533, 1.3513],
        [6362.6817, 99.4982, 26.1367, 13.4745, 9.0314, 6.8908, 5.6601, 4.8694, 4.3211, 3.9196, 3.3716, 2.8795, 2.4329, 2.223, 2.0192, 1.8189, 1.6169, 1.4015, 1.1586]
    ],
    "0.05": [
        [161.4476, 18.5128, 10.128, 7.7086, 6.6079, 5.9874, 5.5914, 5.3177, 5.1174, 4.9646, 4.7472, 4.5431, 4.3512, 4.2597, 4.1709, 4.0847, 4.0012, 3.9201, 3.8508],
        [199.5, 19.0, 9.5521, 6.9443, 5.7861, 5.1433, 4.7374, 4.459, 4.2565, 4.1028, 3.8853, 3.6823, 3.4928, 3.4028, 3.3158, 3.2317, 3.1504, 3.0718, 3.0047],
        [215.7073, 19.1643, 9.2766, 6.5914, 5.4095, 4.7571, 4.3468, 4.0662, 3.8625, 3.7083, 3.4903, 3.2874, 3.0984, 3.0088, 2.9223, 2.8387, 2.7581, 2.6802, 2.6138],
        [224.5832, 19.2468, 9.1172, 6.3882, 5.1922, 4.5337, 4.1203, 3.8379, 3.6331, 3.478, 3.2592, 3.0556, 2.8661, 2.7763, 2.6896, 2.606, 2.5252, 2.4472, 2.3808],
        [230.1619, 19.2964, 9.0135, 6.2561, 5.0503, 4.3874, 3.9715, 3.6875, 3.4817, 3.3258, 3.1059, 2.9013, 2.7109, 2.6207, 2.5336, 2.4495, 2.3683, 2.2899, 2.2231],
        [233.986, 19.3295, 8.9406, 6.1631, 4.9503, 4.2839, 3.866, 3.5806, 3.3738, 3.2172, 2.9961, 2.7905, 2.599, 2.5082, 2.4205, 2.3359, 2.2541, 2.175, 2.1076],
        [236.7684, 19.3532, 8.8867, 6.0942, 4.8759, 4.2067, 3.787, 3.5005, 3.2927, 3.1355, 2.9134, 2.7066, 2.514, 2.4226, 2.3343, 2.249, 2.1665, 2.0868, 2.0187],
        [238.8827, 19.371, 8.8452, 6.041, 4.8183, 4.1468, 3.7257, 3.4381, 3.2296, 3.0717, 2.8486, 2.6408, 2.4471, 2.3551, 2.2662, 2.1802, 2.097, 2.0164, 1.9476],
        [240.5433, 19.3848, 8.8123, 5.9988, 4.7725, 4.099, 3.6767, 3.3881, 3.1789, 3.0204, 2.7964, 2.5876, 2.3928, 2.3002, 2.2107, 2.124, 2.0401, 1.9588, 1.8892],
        [241.8817, 19.3959, 8.7855, 5.9644, 4.7351, 4.06, 3.6365, 3.3472, 3.1373, 2.9782, 2.7534, 2.5437, 2.3479, 2.2547, 2.1646, 2.0772, 1.9926, 1.9105, 1.8402],
        [243.906, 19.4125, 8.7446, 5.9117, 4.6777, 3.9999, 3.5747, 3.2839, 3.0729, 2.913, 2.6866, 2.4753, 2.2776, 2.1834, 2.0921, 2.0035, 1.9174, 1.8337, 1.7618],
        [245.9499, 19.4291, 8.7029, 5.8578, 4.6188, 3.9381, 3.5107, 3.2184, 3.0061, 2.845, 2.6169, 2.4034, 2.2033, 2.1077, 2.0148, 1.9245, 1.8364, 1.7505, 1.6764],
        [248.0131, 19.4458, 8.6602, 5.8025, 4.5581, 3.8742, 3.4445, 3.1503, 2.9365, 2.774, 2.5436, 2.3275, 2.1242, 2.0267, 1.9317, 1.8389, 1.748, 1.6587, 1.5811],
        [249.0518, 19.4541, 8.6385, 5.7744, 4.5272, 3.8415, 3.4105, 3.1152, 2.9005, 2.7372, 2.5055, 2.2878, 2.0825, 1.9838, 1.8874, 1.7929, 1.7001, 1.6084, 1.5282],
        [250.0951, 19.4624, 8.6166, 5.7459, 4.4957, 3.8082, 3.3758, 3.0794, 2.8637, 2.6996, 2.4663, 2.2468, 2.0391, 1.939, 1.8409, 1.7444, 1.6491, 1.5543, 1.4706],
        [251.1432, 19.4707, 8.5944, 5.717, 4.4638, 3.7743, 3.3404, 3.0428, 2.8259, 2.6609, 2.4259, 2.2043, 1.9938, 1.892, 1.7918, 1.6928, 1.5943, 1.4952, 1.4063],
        [252.1957, 19.4791, 8.572, 5.6877, 4.4314, 3.7398, 3.3043, 3.0053, 2.7872, 2.6211, 2.3842, 2.1601, 1.9464, 1.8424, 1.7396, 1.6373, 1.5343, 1.429, 1.3318],
        [253.2529, 19.4874, 8.5494, 5.6581, 4.3985, 3.7047, 3.2674, 2.9669, 2.7475, 2.5801, 2.341, 2.1141, 1.8963, 1.7896, 1.6835, 1.5766, 1.4673, 1.3519, 1.2385],
        [254.1868, 19.4947, 8.5292, 5.6317, 4.369, 3.6732, 3.2343, 2.9324, 2.7116, 2.543, 2.3017, 2.0718, 1.8497, 1.7401, 1.6299, 1.5175, 1.3994, 1.2675, 1.1097]
    ]
}

// [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 15, 20, 24, 30, 40, 60, 120, 1000]
function findIndex(idx:number, within:Array<number>):number {
    let i = 0;
    for (; i < within.length; i += 1) {
        if (idx <= within[i] || i === within.length - 1) {
            break
        }
    }
    return i;
}

function findCritVal(v1:number, v2:number, alphaId:string):number {
    const t = BINOM[alphaId];
    if (t) {
        return t[findIndex(v2, DFLIST)][findIndex(v1, DFLIST)];
    }
    throw new Error(`Failed to fetch critical value for alpha: ${alphaId}, v1: ${v1}, v2: ${v2}`);
}

export function getAvailConfLevels():Array<string> {
    return Object.keys(BINOM);
}

export function confIntervalClopperPearson(v:number, base:number, alphaId:string):[number, number] {
    const v11 = 2 * (base - v + 1);
    const v12 = 2 * v;
    const f1 = findCritVal(v11, v12, alphaId);

    const v21 = 2 * (v + 1);
    const v22 = 2 * (base - v);
    const f2 = findCritVal(v21, v22, alphaId);

    const p1 = v / (v + (base - v + 1) * f1);
    const p2 = (v + 1) * f2 / (base - v + (v + 1) * f2);
    return [p1, p2];
}